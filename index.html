<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Widget - Real Time</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- VISUAL FIXES APPLIED HERE --- */
        
        .body-wrapper {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #3a3897 0%, #2c2a72 40%, #1a1a4e 100%);
            min-height: 100vh;
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInScaleUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { transform: translateY(0) scale(1); } }
        @keyframes gentleBob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes rainFall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(50px); opacity: 0; } }

        .animate-fadeInUp { animation: fadeInUp 0.6s ease-out forwards; }
        .animate-fadeInScaleUp { animation: fadeInScaleUp 0.7s ease-out forwards; }
        .animate-gentleBob { animation: gentleBob 2.5s ease-in-out infinite; }
        
        .delay-100 { animation-delay: 0.1s !important; }
        .delay-200 { animation-delay: 0.2s !important; }
        .delay-300 { animation-delay: 0.3s !important; }
        .delay-400 { animation-delay: 0.4s !important; }
        .delay-500 { animation-delay: 0.5s !important; }
        .delay-600 { animation-delay: 0.6s !important; }
        .delay-700 { animation-delay: 0.7s !important; }

        .cloud-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 100px;
            pointer-events: all;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cloud:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }
        
        .cloud-1 { width: 80px; height: 30px; top: 30px; left: 20px; }
        .cloud-2 { width: 100px; height: 35px; top: 60px; right: 30px; }
        .cloud-3 { width: 70px; height: 25px; bottom: 120px; left: 40%; }
        
        .rain {
            position: absolute;
            width: 2px;
            height: 10px;
            background: rgba(173, 216, 230, 0.7);
            border-radius: 1px;
            animation: rainFall 1.5s linear infinite;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            padding: 0.5rem;
            display: none;
        }
        
        .search-results.active { display: block; }
        
        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }
        
        .search-result-item:hover { background: rgba(255, 255, 255, 0.1); }
        .search-result-item:last-child { border-bottom: none; }

        .error-message {
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .error-message.show { display: block; }

        .info-message {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.875rem;
        }
        
        .info-message.show { display: block; }

        .loading {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* FIX 1: Forecast Icon Spacing */
        .forecast-day .forecast-icon {
            margin-bottom: 5px; 
            /* Ensure the icon itself scales */
            transform: translateY(0);
            transition: transform 0.3s ease-out; 
        }

        /* FIX 2: General Forecast Alignment */
        .forecast-day:hover {
            /* Keep original hover effects */
            transform: translateY(-1px);
        }

    </style>
</head>
<body>
    <div class="body-wrapper min-h-screen flex justify-center items-center p-4">
        <div class="weather-widget-container relative w-full max-w-sm sm:max-w-md">
            <div class="weather-widget relative text-white bg-gradient-to-br from-purple-700/70 via-indigo-800/60 to-blue-900/70 backdrop-blur-lg shadow-2xl rounded-3xl p-6 overflow-hidden border border-white/10">
                
                <div class="cloud-animation" id="cloudAnimation">
                    <div class="cloud cloud-1" onclick="toggleRain()"></div>
                    <div class="cloud cloud-2" onclick="toggleRain()"></div>
                    <div class="cloud cloud-3" onclick="toggleRain()"></div>
                    <div id="rainContainer"></div>
                    <div id="cloudTooltip" class="absolute top-20 right-4 bg-black/70 text-white px-3 py-1.5 rounded-md text-xs opacity-0 transition-opacity duration-300 pointer-events-none z-40 shadow-lg">
                        Click clouds for rain!
                        <div class="absolute -top-1 right-3 w-3 h-3 bg-black/70 transform rotate-45"></div>
                    </div>
                </div>

                <div class="relative z-20">
                    <div class="info-message animate-fadeInUp" id="infoMessage">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle mr-2 mt-0.5"></i>
                            <div>
                                <div id="infoText">Checking API status...</div>
                                <a href="https://home.openweathermap.org/api_keys" target="_blank" class="text-xs underline mt-1 block opacity-80">Check your API key status</a>
                            </div>
                        </div>
                    </div>

                    <div class="error-message animate-fadeInUp" id="errorMessage">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span id="errorText">Failed to load weather data</span>
                        </div>
                    </div>

                    <div class="flex items-center mb-4 animate-fadeInUp">
                        <div class="relative flex-1 mr-2">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="locationSearch" 
                                    placeholder="Search for a city..." 
                                    class="w-full bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl py-2.5 px-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/30 focus:border-white/30 transition-all pr-10"
                                >
                                <i class="fas fa-search absolute right-3 top-3 text-white/60"></i>
                            </div>
                            <div id="searchResults" class="search-results"></div>
                        </div>
                        <button 
                            id="detectLocationBtn" 
                            class="bg-white/10 backdrop-blur-sm hover:bg-white/20 border border-white/20 rounded-xl p-2.5 transition-all flex items-center justify-center"
                            title="Detect my location"
                        >
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>

                    <div class="date-time text-sm font-light opacity-80 mb-1 tracking-wide animate-fadeInUp" id="dateTime"></div>

                    <div class="current-weather flex items-center mb-2">
                        <div class="weather-icon-main text-5xl mr-3" id="weatherIcon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="temp text-5xl font-semibold">
                            <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-300 animate-fadeInScaleUp delay-100" id="temperature"></span>
                        </div>
                    </div>

                    <div class="location text-lg opacity-90 mb-4 tracking-wide animate-fadeInUp delay-200 flex items-center justify-between" id="location">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-white/70"></i>
                            <span id="locationText"></span>
                        </div>
                        <button id="refreshBtn" class="text-white/70 hover:text-white transition-colors" title="Refresh weather">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <div class="sun-info bg-black/30 backdrop-blur-sm rounded-2xl p-3 sm:p-4 flex justify-between items-center mb-4 border border-white/10 shadow-md animate-fadeInUp delay-300">
                        <div class="sunrise text-center">
                            <div class="sun-icon text-xl mb-1">ðŸŒ…</div>
                            <div class="text-xs opacity-80" id="sunriseTime"></div>
                        </div>
                        <div class="day-length text-center text-sm opacity-90" id="dayLength"></div>
                        <div class="sunset text-center">
                            <div class="sun-icon text-xl mb-1">ðŸŒ‡</div>
                            <div class="text-xs opacity-80" id="sunsetTime"></div>
                        </div>
                    </div>

                    <div class="additional-info grid grid-cols-2 gap-3 mb-5">
                        <div class="precipitation bg-white/10 backdrop-blur-sm rounded-xl p-3 flex items-center border border-white/5 shadow-sm animate-fadeInUp delay-400">
                            <div class="precip-icon text-2xl mr-2 text-blue-300 drop-shadow-lg animate-gentleBob">
                                <i class="fas fa-cloud-rain"></i>
                            </div>
                            <div>
                                <div class="text-xs opacity-70">Precipitation</div>
                                <div class="text-sm font-medium" id="precipitationChance"></div>
                            </div>
                        </div>
                        
                        <div class="humidity bg-white/10 backdrop-blur-sm rounded-xl p-3 flex items-center border border-white/5 shadow-sm animate-fadeInUp delay-500">
                            <div class="humidity-icon text-2xl mr-2 text-blue-300 drop-shadow-lg">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div>
                                <div class="text-xs opacity-70">Humidity</div>
                                <div class="text-sm font-medium" id="humidity"></div>
                            </div>
                        </div>
                        
                        <div class="wind bg-white/10 backdrop-blur-sm rounded-xl p-3 flex items-center border border-white/5 shadow-sm animate-fadeInUp delay-600">
                            <div class="wind-icon text-2xl mr-2 text-blue-300 drop-shadow-lg">
                                <i class="fas fa-wind"></i>
                            </div>
                            <div>
                                <div class="text-xs opacity-70">Wind</div>
                                <div class="text-sm font-medium" id="windSpeed"></div>
                            </div>
                        </div>
                        
                        <div class="pressure bg-white/10 backdrop-blur-sm rounded-xl p-3 flex items-center border border-white/5 shadow-sm animate-fadeInUp delay-700">
                            <div class="pressure-icon text-2xl mr-2 text-blue-300 drop-shadow-lg">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </div>
                            <div>
                                <div class="text-xs opacity-70">Pressure</div>
                                <div class="text-sm font-medium" id="pressure"></div>
                            </div>
                        </div>
                    </div>

                    <div class="forecast flex flex-nowrap justify-between pb-2 overflow-x-auto" id="forecastContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEATHER_API_KEY = '7102fa3321dffd473ab8b5fc769c8eca';
        const OPENWEATHER_API_URL = 'https://api.openweathermap.org/data/2.5';
        const GEO_API_URL = 'https://api.openweathermap.org/geo/1.0';

        let currentLocation = { name: "New York, US", lat: 40.7128, lon: -74.0060 };
        let searchTimeout;
        let isRaining = false;

        const weatherIcons = {
            '01d': 'fas fa-sun', '01n': 'fas fa-moon', 
            '02d': 'fas fa-cloud-sun', '02n': 'fas fa-cloud-moon',    
            '03d': 'fas fa-cloud', '03n': 'fas fa-cloud', 
            '04d': 'fas fa-cloud', '04n': 'fas fa-cloud',
            '09d': 'fas fa-cloud-rain', '09n': 'fas fa-cloud-rain', 
            '10d': 'fas fa-cloud-sun-rain', '10n': 'fas fa-cloud-moon-rain', 
            '11d': 'fas fa-bolt', '11n': 'fas fa-bolt',
            '13d': 'fas fa-snowflake', '13n': 'fas fa-snowflake', 
            '50d': 'fas fa-smog', '50n': 'fas fa-smog'
        };

        function init() {
            hideError();
            hideInfo();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            setupEventListeners();
            getWeatherData(currentLocation.lat, currentLocation.lon, currentLocation.name);
            
            setTimeout(() => {
                const tooltip = document.getElementById('cloudTooltip');
                if (tooltip) {
                    tooltip.style.opacity = '1';
                    setTimeout(() => tooltip.style.opacity = '0', 3000);
                }
            }, 2000);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', hour: '2-digit', minute: '2-digit', hour12: false };
            document.getElementById('dateTime').textContent = now.toLocaleString('en-US', options);
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('locationSearch');
            const detectBtn = document.getElementById('detectLocationBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const cloudAnimationEl = document.getElementById('cloudAnimation'); // Get cloud animation element

            if (searchInput) searchInput.addEventListener('input', handleSearchInput);
            if (searchInput) searchInput.addEventListener('blur', () => setTimeout(() => hideSearchResults(), 200));
            if (detectBtn) detectBtn.addEventListener('click', detectLocation);
            if (refreshBtn) refreshBtn.addEventListener('click', () => {
                getWeatherData(currentLocation.lat, currentLocation.lon, currentLocation.name);
            });
            if (cloudAnimationEl) cloudAnimationEl.addEventListener('click', toggleRain);
        }

        async function handleSearchInput(e) {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);
            
            if (query.length < 3) {
                hideSearchResults();
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const results = await geocodeSearch(query);
                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 500);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="text-white/70 px-4 py-2 text-sm">No results found</div>';
                container.classList.add('active');
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="search-result-item text-white" onclick='selectLocation(${JSON.stringify(result).replace(/'/g, "&#39;")})'>
                    <i class="fas fa-map-marker-alt mr-2 text-white/50"></i>
                    ${result.name}
                </div>
            `).join('');
            
            container.classList.add('active');
        }

        function hideSearchResults() {
            document.getElementById('searchResults').classList.remove('active');
        }

        function selectLocation(location) {
            document.getElementById('locationSearch').value = '';
            hideSearchResults();
            getWeatherData(location.lat, location.lon, location.name);
        }

        function detectLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser');
                return;
            }

            const btn = document.getElementById('detectLocationBtn');
            btn.innerHTML = '<div class="loading h-5 w-5"></div>';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const locationName = await reverseGeocode(latitude, longitude);
                        getWeatherData(latitude, longitude, locationName);
                    } catch (error) {
                        showError('Failed to get location name');
                    }
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
                },
                (error) => {
                    showError('Unable to retrieve your location');
                    btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
                }
            );
        }

        async function geocodeSearch(query) {
            const url = `${GEO_API_URL}/direct?q=${encodeURIComponent(query)}&limit=5&appid=${WEATHER_API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Geocoding failed');
            }
            const data = await response.json();
            return data.map(item => ({
                name: `${item.name}, ${item.state ? item.state + ', ' : ''}${item.country}`,
                lat: item.lat,
                lon: item.lon,
            }));
        }

        async function reverseGeocode(lat, lon) {
            const url = `${GEO_API_URL}/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${WEATHER_API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Reverse geocoding failed');
            const data = await response.json();
            if (data && data.length > 0) {
                const result = data[0];
                return `${result.name}, ${result.country}`;
            }
            return 'Unknown Location';
        }

        async function getWeatherData(lat, lon, locationName) {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.innerHTML = '<div class="loading h-5 w-5"></div>';
            hideError();
            hideInfo();
            
            try {
                const weatherUrl = `${OPENWEATHER_API_URL}/weather?lat=${lat}&lon=${lon}&units=metric&appid=${WEATHER_API_KEY}`;
                const forecastUrl = `${OPENWEATHER_API_URL}/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${WEATHER_API_KEY}`;

                const [weatherResponse, forecastResponse] = await Promise.all([
                    fetch(weatherUrl),
                    fetch(forecastUrl)
                ]);

                if (!weatherResponse.ok) {
                    const errorData = await weatherResponse.json();
                    
                    if (weatherResponse.status === 401) {
                        showInfo('API Key Error: Your API key may be invalid or not activated yet. Please check your OpenWeatherMap account.');
                    } else {
                        showError(`API Error (${weatherResponse.status}): ${errorData.message || 'Unknown error'}`);
                    }
                    return;
                }

                if (!forecastResponse.ok) {
                    const errorData = await forecastResponse.json();
                    showError(`Forecast API Error: ${errorData.message || 'Unknown error'}`);
                    return;
                }

                const weatherData = await weatherResponse.json();
                const forecastData = await forecastResponse.json();

                updateWeatherUI(weatherData, forecastData, locationName);
                currentLocation = { name: locationName, lat, lon };

            } catch (error) {
                showError(`Network Error: ${error.message}. Please check your internet connection and API key.`);
            } finally {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }
        }

        function updateWeatherUI(weatherData, forecastData, locationName) {
            document.getElementById('locationText').textContent = locationName;
            document.getElementById('temperature').textContent = `${Math.round(weatherData.main.temp)}Â°C`;
            
            const iconCode = weatherData.weather[0].icon;
            const iconClass = weatherIcons[iconCode] || 'fas fa-cloud';
            document.getElementById('weatherIcon').innerHTML = `<i class="${iconClass}"></i>`;

            const sunrise = new Date(weatherData.sys.sunrise * 1000);
            const sunset = new Date(weatherData.sys.sunset * 1000);
            document.getElementById('sunriseTime').textContent = sunrise.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('sunsetTime').textContent = sunset.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const dayLengthSeconds = weatherData.sys.sunset - weatherData.sys.sunrise;
            const hours = Math.floor(dayLengthSeconds / 3600);
            const minutes = Math.floor((dayLengthSeconds % 3600) / 60);
            document.getElementById('dayLength').textContent = `${hours} h ${minutes} m`;

            let precipitation = 0;
            if (forecastData.list && forecastData.list[0] && forecastData.list[0].pop !== undefined) {
                precipitation = Math.round(forecastData.list[0].pop * 100);
            }
            
            document.getElementById('precipitationChance').textContent = `${precipitation}%`;
            document.getElementById('humidity').textContent = `${weatherData.main.humidity}%`;
            document.getElementById('windSpeed').textContent = `${Math.round(weatherData.wind.speed * 3.6)} km/h`;
            document.getElementById('pressure').textContent = `${weatherData.main.pressure} hPa`;

            updateForecast(forecastData);
            hideError();
            hideInfo();
        }

        function updateForecast(forecastData) {
            const container = document.getElementById('forecastContainer');
            const dailyForecasts = [];
            const seenDates = new Set();
            
            for (const item of forecastData.list) {
                const date = new Date(item.dt * 1000);
                const dateStr = date.toDateString();
                
                if (!seenDates.has(dateStr) && date.getHours() >= 12) {
                    seenDates.add(dateStr);
                    dailyForecasts.push({
                        day: date.toLocaleDateString('en-US', { weekday: 'short' }),
                        icon: weatherIcons[item.weather[0].icon] || 'fas fa-cloud',
                        high: Math.round(item.main.temp_max),
                        low: Math.round(item.main.temp_min)
                    });
                    
                    if (dailyForecasts.length === 5) break;
                }
            }

            container.innerHTML = dailyForecasts.map((day, index) => `
                <div class="forecast-day bg-white/5 backdrop-blur-sm rounded-xl p-3 min-w-[80px] text-center border border-white/10 shadow-sm hover:bg-white/10 transition-all duration-200 cursor-pointer transform hover:-translate-y-1 animate-fadeInUp delay-${500 + index * 100} mr-2 last:mr-0 flex-shrink-0">
                    <div class="day-name text-xs font-medium mb-1 opacity-80">${day.day}</div>
                    <div class="forecast-icon text-xl my-1 drop-shadow-md"><i class="${day.icon}"></i></div>
                    <div class="high-temp text-sm font-semibold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-300">${day.high}Â°</div>
                    <div class="low-temp text-xs opacity-70">${day.low}Â°</div>
                </div>
            `).join('');
        }

        function toggleRain() {
            isRaining = !isRaining;
            const container = document.getElementById('rainContainer');
            
            if (isRaining) {
                container.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain';
                    drop.style.left = `${Math.random() * 100}%`;
                    drop.style.animationDelay = `${Math.random() * 2}s`;
                    drop.style.animationDuration = `${1 + Math.random()}s`;
                    container.appendChild(drop);
                }
            } else {
                container.innerHTML = '';
            }
        }

        function showError(message) {
            console.error('Error:', message);
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        function showInfo(message) {
            console.info('Info:', message);
            document.getElementById('infoText').textContent = message;
            document.getElementById('infoMessage').classList.add('show');
        }

        function hideInfo() {
            document.getElementById('infoMessage').classList.remove('show');
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>